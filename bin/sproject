#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/common.sh"

usage() {
  cat << EOF
Usage: $(basename "$0") <project> [port]

SSH to remote desktop and run tat on project (auto-detects local/remote).

Arguments:
  project    Project path (e.g., dinum/siade)
  port       Optional port to tunnel in background

Options:
  -h, --help    Show this help message

Examples:
  $(basename "$0") dinum/siade
  $(basename "$0") dinum/siade 3000
EOF
  exit 0
}

[[ "${1:-}" == "-h" || "${1:-}" == "--help" ]] && usage

if [[ -z "${1:-}" ]]; then
  echo "Error: project argument required" >&2
  usage
fi

PROJECT="$1"
PORT="${2:-}"

HOST=$(detect_host)

TUNNEL_PID=""

cleanup() {
  if [[ -n "$TUNNEL_PID" ]]; then
    kill "$TUNNEL_PID" 2>/dev/null || true
  fi
}

trap cleanup EXIT

if [[ -n "$PORT" ]]; then
  ssh -N -L "$PORT:localhost:$PORT" "$HOST" &
  TUNNEL_PID=$!
  echo "Tunnel started on port $PORT (PID: $TUNNEL_PID)"
  sleep 1
fi

PROJECT_NAME=$(basename "$PROJECT")
echo -ne "\033]0;r $PROJECT_NAME\007"

SRUN_PORT=""
if [[ -f ~/.srun-port ]]; then
  SRUN_PORT=$(cat ~/.srun-port)
fi

ssh -t "$HOST" "echo '$SRUN_PORT' > ~/.srun-port-active; cd ~/work/$PROJECT && PATH=\"\$PATH:/opt/homebrew/bin\" ~/.bin/tat"
