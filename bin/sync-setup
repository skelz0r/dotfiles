#!/usr/bin/env bash

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

usage() {
  cat << EOF
Usage: $(basename "$0") [OPTIONS]

Setup Syncthing with ~/share folder.

Options:
  --device-id <ID>    Add remote device by ID
  -h, --help          Show this help message

Examples:
  $(basename "$0")
  $(basename "$0") --device-id 5ZQYEWX-5RZWIE6-...
EOF
  exit 0
}

[[ "${1:-}" == "-h" || "${1:-}" == "--help" ]] && usage

REMOTE_DEVICE_ID="${2:-}"
[[ "${1:-}" == "--device-id" && -z "$REMOTE_DEVICE_ID" ]] && echo "Error: --device-id requires an argument" && exit 1

echo -e "${BLUE}Setting up Syncthing...${NC}"

if ! command -v syncthing &> /dev/null; then
  echo -e "${YELLOW}Installing Syncthing...${NC}"
  brew install syncthing
fi

if ! brew services list | grep syncthing | grep started &> /dev/null; then
  echo -e "${YELLOW}Starting Syncthing service...${NC}"
  brew services start syncthing
  sleep 3
fi

mkdir -p "$HOME/share"
echo -e "${GREEN}✓${NC} Created ~/share"

CONFIG_DIR="$HOME/Library/Application Support/Syncthing"
if [[ ! -f "$CONFIG_DIR/config.xml" ]]; then
  echo -e "${RED}Waiting for Syncthing to initialize...${NC}"
  sleep 5
fi

API_KEY=$(grep '<apikey>' "$CONFIG_DIR/config.xml" | sed 's/.*<apikey>\(.*\)<\/apikey>.*/\1/')
DEVICE_ID=$(grep '<device id=' "$CONFIG_DIR/config.xml" | head -1 | sed 's/.*id="\([^"]*\)".*/\1/')

if curl -s -H "X-API-Key: $API_KEY" http://127.0.0.1:8384/rest/config/folders | grep -q '"id":"share"'; then
  echo -e "${GREEN}✓${NC} Folder 'share' already configured"
else
  echo -e "${YELLOW}Configuring 'share' folder...${NC}"
  curl -s -X POST -H "X-API-Key: $API_KEY" \
    -H "Content-Type: application/json" \
    -d '{
      "id": "share",
      "label": "Share",
      "path": "'"$HOME/share"'",
      "type": "sendreceive",
      "rescanIntervalS": 3600,
      "fsWatcherEnabled": true,
      "fsWatcherDelayS": 1,
      "ignorePerms": false,
      "autoNormalize": true
    }' \
    http://127.0.0.1:8384/rest/config/folders > /dev/null
  echo -e "${GREEN}✓${NC} Folder 'share' configured"
fi

if [[ -n "$REMOTE_DEVICE_ID" ]]; then
  echo -e "${YELLOW}Adding remote device...${NC}"
  curl -s -X POST -H "X-API-Key: $API_KEY" \
    -H "Content-Type: application/json" \
    -d '{
      "deviceID": "'"$REMOTE_DEVICE_ID"'",
      "name": "Remote",
      "addresses": ["dynamic"],
      "compression": "metadata",
      "introducer": false
    }' \
    http://127.0.0.1:8384/rest/config/devices > /dev/null
  echo -e "${GREEN}✓${NC} Remote device added"
fi

echo ""
echo -e "${GREEN}Setup complete!${NC}"
echo ""
echo -e "${BLUE}This device ID:${NC}"
echo -e "${YELLOW}$DEVICE_ID${NC}"
echo ""
echo -e "${BLUE}Web UI:${NC} http://127.0.0.1:8384"
echo ""
echo -e "${BLUE}Next steps:${NC}"
echo "1. On other machine: sync-setup --device-id $DEVICE_ID"
echo "2. Accept device pairing in Web UI"
echo "3. Test: echo 'test' > ~/share/test.txt"
