#!/usr/bin/env bash
#
# battery - Show battery level formatted for tmux status bar
#
# Supports macOS and Linux

battery_charge_macos() {
  ioreg -c AppleSmartBattery -w0 | \
    grep -o '"[^"]*" = [^ ]*' | \
    sed -e 's/= //g' -e 's/"//g' | \
    sort | \
    while read key value; do
      case $key in
        "MaxCapacity")
          export maxcap=$value;;
        "CurrentCapacity")
          export curcap=$value;;
      esac
      if [[ -n "$maxcap" && -n $curcap ]]; then
        CAPACITY=$(( 100 * curcap / maxcap))
        printf "%d" $CAPACITY
        break
      fi
    done
}

battery_charge_linux() {
  local bat_path="/sys/class/power_supply/BAT0"
  [[ -d "$bat_path" ]] || bat_path="/sys/class/power_supply/BAT1"
  [[ -d "$bat_path" ]] || return 1

  if [[ -f "$bat_path/capacity" ]]; then
    cat "$bat_path/capacity"
  elif [[ -f "$bat_path/energy_now" && -f "$bat_path/energy_full" ]]; then
    local now=$(cat "$bat_path/energy_now")
    local full=$(cat "$bat_path/energy_full")
    echo $(( 100 * now / full ))
  else
    return 1
  fi
}

battery_charge() {
  case "$(uname -s)" in
    Darwin) battery_charge_macos ;;
    Linux)  battery_charge_linux ;;
    *)      return 1 ;;
  esac
}

battery_info() {
  if [[ "$(uname -s)" == "Darwin" ]]; then
    pmset -g batt | grep InternalBattery
  fi
}

BATTERY_STATUS=$(battery_charge)
[ -z "$BATTERY_STATUS" ] && exit 1

BATT_INFO=$(battery_info)

# Determine charging status
if echo "$BATT_INFO" | grep -q "discharging"; then
  STATUS_ICON="ðŸ”‹"
else
  STATUS_ICON="âš¡"
fi

# Extract time remaining
if echo "$BATT_INFO" | grep -q "remaining"; then
  TIME=$(echo "$BATT_INFO" | grep -Eo "[0-9]+:[0-9]+ remaining" | awk '{print $1}')
elif echo "$BATT_INFO" | grep -q "until full"; then
  TIME=$(echo "$BATT_INFO" | grep -Eo "[0-9]+:[0-9]+ until full" | awk '{print $1}')
else
  TIME="ðŸ¤·"
fi

if [ "$BATTERY_STATUS" -lt 25 ]; then
  fg=colour210
  bg=colour88
elif [ "$BATTERY_STATUS" -lt 75 ]; then
  fg=colour228
  bg=colour94
else
  fg=colour8
  bg=colour234
fi

printf "#[fg=${fg},bg=${bg}] %s %2d%% %s" "$STATUS_ICON" "$BATTERY_STATUS" "$TIME"
