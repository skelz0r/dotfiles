Fix the following bug: $1

Steps:
1. Understand the bug by exploring the codebase
2. Write a non-regression test that fails (if relevant)
3. Fix the bug
4. Ensure test passes
5. Commit everything in a single atomic commit
6. Refactor code (if relevant)
