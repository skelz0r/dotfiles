#!/usr/bin/env bash

set -euo pipefail

PORTS=(22222 22223)

usage() {
  cat << EOF
Usage: $(basename "$0") <sim|phy> <project>

Run srun-sim/srun-phy on the local machine via reverse SSH tunnel.
Use this from a remote session (sproject) to build on remote but
install/run on your local machine.

Setup: Create ~/.srun-port on each local machine with its port number.
       Configure matching RemoteForward in SSH config.

Arguments:
  sim|phy    Target: simulator or physical device
  project    Project path relative to ~/work

Examples:
  $(basename "$0") sim local_events
  $(basename "$0") phy tiny_weather
EOF
  exit 0
}

[[ "${1:-}" == "-h" || "${1:-}" == "--help" ]] && usage

if [[ -z "${1:-}" || -z "${2:-}" ]]; then
  echo "Error: arguments required" >&2
  usage
fi

TARGET="$1"
PROJECT="$2"

case "$TARGET" in
  sim)
    CMD="srun-sim"
    ;;
  phy)
    CMD="srun-phy"
    ;;
  *)
    echo "Error: target must be 'sim' or 'phy'" >&2
    exit 1
    ;;
esac

for p in "${PORTS[@]}"; do
  if ssh -p "$p" -o ConnectTimeout=1 -o BatchMode=yes localhost "cat ~/.srun-port" 2>/dev/null | grep -q "^$p$"; then
    PORT="$p"
    break
  fi
done

if [[ -z "${PORT:-}" ]]; then
  echo "Error: no matching reverse tunnel found" >&2
  echo "Ensure ~/.srun-port exists on local machine with port number" >&2
  exit 1
fi

echo "Running $CMD $PROJECT on local machine (port $PORT)..."
ssh -p "$PORT" localhost "$CMD $PROJECT"
